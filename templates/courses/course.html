{% extends 'base.html' %}
{% block content %}
    <div class="container">
        <h1 class="my-4">{{ course.title }}</h1>

        <div class="row">
            <div class="col-md-8">
                <div class="cover-wrapper">
                    <img id="course-cover" class="img-fluid" src="{{ slides.0.image.url }}" alt="">
                    <div class="cover-overlay">
                        <button id="play-course">
                            <span class="btn btn-default"></span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <h3 class="my-3">Course Description</h3>
                <p>{{ course.description }}</p>
            </div>
        </div>

        <h3 class="my-4">All slides</h3>
        <div class="row">
            {% for slide in slides %}
                <div class="col-md-3 col-sm-6 mb-4">
                    <img id="image{{ slide.number }}" class="img-fluid" src="{{ slide.image.url }}">
                </div>
            {% endfor %}
        </div>

        <div class="modal-footer">
            <a href="{% url 'delete_course' course_id=course.id %}">
                <button id="delete" class="btn btn-outline-dark" type="submit">Удалить</button>
            </a>
        </div>
    </div>

    <div id="slideshow-modal" class="modal-centered modal">
        <div class="modal-content">
            <img src="" class="slideshow-image" id="slideshow">
            <div class="audio green-audio-player">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
                <div class="play-pause-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="24" viewBox="0 0 18 24">
                        <path fill="#566574" fill-rule="evenodd" d="M18 12L0 24V0" class="play-pause-icon"
                              id="playPause"></path>
                    </svg>
                </div>

                <div class="controls">
                    <span class="current-time">0:00</span>
                    <div class="slider" data-direction="horizontal">
                        <div class="progress">
                            <div class="pin" id="progress-pin" data-method="rewind"></div>
                        </div>
                    </div>
                    <span class="total-time">0:00</span>
                </div>

                <div class="volume">
                    <div class="volume-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                            <path fill="#566574" fill-rule="evenodd"
                                  d="M14.667 0v2.747c3.853 1.146 6.666 4.72 6.666 8.946 0 4.227-2.813 7.787-6.666 8.934v2.76C20 22.173 24 17.4 24 11.693 24 5.987 20 1.213 14.667 0zM18 11.693c0-2.36-1.333-4.386-3.333-5.373v10.707c2-.947 3.333-2.987 3.333-5.334zm-18-4v8h5.333L12 22.36V1.027L5.333 7.693H0z"
                                  id="speaker"></path>
                        </svg>
                    </div>
                    <div class="volume-controls hidden">
                        <div class="slider" data-direction="vertical">
                            <div class="progress">
                                <div class="pin" id="volume-pin" data-method="changeVolume"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <audio crossorigin>
                    <source src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/355309/Swing_Jazz_Drum.mp3"
                            type="audio/mpeg">
                </audio>
            </div>
            <div id="comment-list" class="comment-list">
            </div>
            <div class="write-comment-block">
                <div class="card-body">
                    <div class="form-group">
                        <textarea class="form-control" id="comment-text" rows="2"></textarea>
                    </div>
                    <button class="btn btn-dark" id="send-comment">Submit</button>
                </div>
            </div>
        </div>
    </div>

    <div id="slide-modal" class="modal-centered modal">
        <div class="modal-content">
            <img src="" class="slideshow-image" id="slide">
        </div>
    </div>

    <script>

        {% autoescape off %}
            let slideList = [];
            let comments;
            {% for slide in slides %}
                comments = [];
                {% for comment in slide.comments %}
                    comments.push({
                        id: {{ comment.id }},
                        slideID: {{ comment.slide_id }},
                        authorID: {{ comment.author_id }},
                        authorName: '{{ comment.author_name }}',
                        text: '{{ comment.text }}'
                    })
                {% endfor %}
                slideList.push({
                    id: {{ slide.id }},
                    number: {{ slide.number }},
                    image: '{{ slide.image.url }}',
                    comments: comments
                });
            {% endfor %}
        {% endautoescape %}

        let currentSlideshowImageId;
        let currentSlideshowImageNumber;

        $('#play-course').click(function () {
            console.log(slideList);
            $('#slideshow-modal').modal();
            $('#slideshow').attr('src', $('#image0').attr('src'));

            currentSlideshowImageNumber = 0;
            currentSlideshowImageId = slideList[0].id;

            addCommentList(currentSlideshowImageId);
        });

        $('img[id^=image]').click(function () {
            {# deleting 'image' from id #}
            currentSlideshowImageNumber = parseInt(this.id.substr(5));

            $('#slide-modal').modal();
            $('#slide').attr('src', this.src);
        });

        $('#send-comment').click(function () {
            let commentField = $('#comment-text')
            let commentText = commentField.val();
            $.ajax({
                url: baseUrl + 'courses/save_slide_comment',
                type: 'POST',
                dataType: "json",
                data: JSON.stringify({'text': commentText, 'slide_id': currentSlideshowImageId}),
                success: function (commentData) {
                    let comment = {
                        id: commentData.id,
                        slideID: commentData.slide_id,
                        authorID: commentData.author_id,
                        authorName: commentData.author_name,
                        text: commentData.text
                    }

                    $.grep(slideList, function (e) {
                        return e.id === currentSlideshowImageId;
                    })[0].comments.push(comment);

                    $('#comment-list').append($('<br>'));
                    addCommentToList(comment.slideID, comment);

                    commentField.val('');
                },
                error: function (data) {
                    console.log('error');
                }
            });
        });

        function addCommentList(slideID) {
            console.log(slideID);
            let slide = $.grep(slideList, function (e) {
                return e.id === slideID
            })[0]

            let commentList = $('#comment-list');
            commentList.empty();
            for (let i = 0; i < slide.comments.length; ++i) {
                if (i !== 0) commentList.append('<br>');
                addCommentToList(slideID, slide.comments[i]);
            }
        }

        function addCommentToList(slideID, comment) {
            let commentList = $('#comment-list');
            let commentBlockWrapper = $('<div>', {class: "comment-block media mb-0"})
            let authorImage = $('<img>', {
                class: "d-flex mr-3 rounded-circle",
                src: "http://placehold.it/50x50"
            })
            let commentWrapper = $('<div>', {class: "media-body"})
            let commentAuthor = $('<div>', {
                class: "mt-0 commenter-name",
                text: comment.authorID === -1 ? "Anonymous" : comment.authorName
            })
            let commentText = $('<div>', {
                class: "comment",
                text: comment.text
            })

            commentWrapper.append(commentAuthor);
            commentWrapper.append(commentText);

            commentBlockWrapper.append(authorImage);
            commentBlockWrapper.append(commentWrapper);

            commentList.append(commentBlockWrapper);
        }

        let audioPlayer = document.querySelector('.green-audio-player');
        let playPause = audioPlayer.querySelector('#playPause');
        let playpauseBtn = audioPlayer.querySelector('.play-pause-btn');
        let loading = audioPlayer.querySelector('.loading');
        let progress = audioPlayer.querySelector('.progress');
        let sliders = audioPlayer.querySelectorAll('.slider');
        let volumeBtn = audioPlayer.querySelector('.volume-btn');
        let volumeControls = audioPlayer.querySelector('.volume-controls');
        let volumeProgress = volumeControls.querySelector('.slider .progress');
        let player = audioPlayer.querySelector('audio');
        let currentTime = audioPlayer.querySelector('.current-time');
        let totalTime = audioPlayer.querySelector('.total-time');
        let speaker = audioPlayer.querySelector('#speaker');

        let draggableClasses = ['pin'];
        let currentlyDragged = null;

        window.addEventListener('mousedown', function (event) {

            if (!isDraggable(event.target)) return false;

            currentlyDragged = event.target;
            let handleMethod = currentlyDragged.dataset.method;

            this.addEventListener('mousemove', window[handleMethod], false);

            window.addEventListener('mouseup', () => {
                currentlyDragged = false;
                window.removeEventListener('mousemove', window[handleMethod], false);
            }, false);
        });

        playpauseBtn.addEventListener('click', togglePlay);
        player.addEventListener('timeupdate', updateProgress);
        player.addEventListener('volumechange', updateVolume);
        player.addEventListener('loadedmetadata', () => {
            totalTime.textContent = formatTime(player.duration);
        });
        player.addEventListener('canplay', makePlay);
        player.addEventListener('ended', function () {
            playPause.attributes.d.value = "M18 12L0 24V0";
            player.currentTime = 0;
        });

        volumeBtn.addEventListener('click', () => {
            volumeBtn.classList.toggle('open');
            volumeControls.classList.toggle('hidden');
        })

        window.addEventListener('resize', directionAware);

        sliders.forEach(slider => {
            let pin = slider.querySelector('.pin');
            slider.addEventListener('click', window[pin.dataset.method]);
        });

        directionAware();

        function isDraggable(el) {
            let canDrag = false;
            let classes = Array.from(el.classList);
            draggableClasses.forEach(draggable => {
                if (classes.indexOf(draggable) !== -1)
                    canDrag = true;
            })
            return canDrag;
        }

        function inRange(event) {
            let rangeBox = getRangeBox(event);
            let rect = rangeBox.getBoundingClientRect();
            let direction = rangeBox.dataset.direction;
            if (direction === 'horizontal') {
                let min = rangeBox.offsetLeft;
                let max = min + rangeBox.offsetWidth;
                if (event.clientX < min || event.clientX > max) return false;
            } else {
                let min = rect.top;
                let max = min + rangeBox.offsetHeight;
                if (event.clientY < min || event.clientY > max) return false;
            }
            return true;
        }

        function updateProgress() {
            let current = player.currentTime;
            let percent = (current / player.duration) * 100;
            progress.style.width = percent + '%';

            currentTime.textContent = formatTime(current);

            /* TODO: add changing slides here */
            let slidesTime = [5, 10, 15, 20, 25, 30, 35];
            for (let i = currentSlideshowImageNumber; i < slidesTime.length; ++i) {
                if (player.currentTime > slidesTime[i]) {
                    currentSlideshowImageId++;
                    currentSlideshowImageNumber++;

                    $('#slideshow').attr('src', $('#image' + currentSlideshowImageNumber).attr('src'));
                    addCommentList(currentSlideshowImageId);
                } else break;
            }
        }

        function updateVolume() {
            volumeProgress.style.height = player.volume * 100 + '%';
            if (player.volume >= 0.5) {
                speaker.attributes.d.value = 'M14.667 0v2.747c3.853 1.146 6.666 4.72 6.666 8.946 0 4.227-2.813 7.787-6.666 8.934v2.76C20 22.173 24 17.4 24 11.693 24 5.987 20 1.213 14.667 0zM18 11.693c0-2.36-1.333-4.386-3.333-5.373v10.707c2-.947 3.333-2.987 3.333-5.334zm-18-4v8h5.333L12 22.36V1.027L5.333 7.693H0z';
            } else if (player.volume < 0.5 && player.volume > 0.05) {
                speaker.attributes.d.value = 'M0 7.667v8h5.333L12 22.333V1L5.333 7.667M17.333 11.373C17.333 9.013 16 6.987 14 6v10.707c2-.947 3.333-2.987 3.333-5.334z';
            } else if (player.volume <= 0.05) {
                speaker.attributes.d.value = 'M0 7.667v8h5.333L12 22.333V1L5.333 7.667';
            }
        }

        function getRangeBox(event) {
            let rangeBox = event.target;
            let el = currentlyDragged;
            if (event.type === 'click' && isDraggable(event.target)) {
                rangeBox = event.target.parentElement.parentElement;
            }
            if (event.type === 'mousemove') {
                rangeBox = el.parentElement.parentElement;
            }
            return rangeBox;
        }

        function getCoefficient(event) {
            let slider = getRangeBox(event);
            let rect = slider.getBoundingClientRect();
            let K = 0;
            if (slider.dataset.direction === 'horizontal') {
                let offsetX = event.clientX - slider.offsetLeft;
                let width = slider.clientWidth;
                K = offsetX / width;
            } else if (slider.dataset.direction === 'vertical') {
                let height = slider.clientHeight;
                let offsetY = event.clientY - rect.top;
                K = 1 - offsetY / height;
            }
            return K;
        }

        function rewind(event) {
            if (inRange(event)) {
                player.currentTime = player.duration * getCoefficient(event);
            }
        }

        function changeVolume(event) {
            if (inRange(event)) {
                player.volume = getCoefficient(event);
            }
        }

        function formatTime(time) {
            let min = Math.floor(time / 60);
            let sec = Math.floor(time % 60);
            return min + ':' + ((sec < 10) ? ('0' + sec) : sec);
        }

        function togglePlay() {
            if (player.paused) {
                playPause.attributes.d.value = "M0 0h6v24H0zM12 0h6v24h-6z";
                player.play();
            } else {
                playPause.attributes.d.value = "M18 12L0 24V0";
                player.pause();
            }
        }

        function makePlay() {
            playpauseBtn.style.display = 'block';
            loading.style.display = 'none';
        }

        function directionAware() {
            volumeControls.style.bottom = '52px';
            volumeControls.style.left = '-3px';
        }


    </script>

{% endblock %}
