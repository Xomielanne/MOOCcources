{% extends "base.html" %}
{% load static %}
{% block content %}
    <div class="container">
        <h1 class="my-4">Создать курс</h1>
        <div class="form-group">
            <label for="title">Название</label>
            <input id="title" class="form-control">
        </div>
        <div class="form-group">
            <label for="description">Описание</label>
            <textarea id="description" class="form-control" rows="4"></textarea>
        </div>

        <div id="presentation-input-group" class="form-group">
            <label for="upload">Презентация</label>
            <input id="presentation-input" type="file" multiple/>
        </div>
        <div id="audio-input-group" class="form-group">
            <label for="upload">Аудио-файл</label>
            <input id="audio-input" type="file"/>
        </div>

        <h2 class="my-4" id="cover-label">Текущий слайд</h2>
        {% include "courses/presentation-player.html" %}
        <div id="slide-controllers" class="btn-group">
            <button id="next-slide-button" class="btn btn-dark">Следующий слайд</button>
            <div class="dropdown">
                <button id="choose-slide-button" class="btn btn-secondary dropdown-toggle" type="button"
                        data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Выбрать слайд
                </button>
                <div id="slide-list" class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                </div>
            </div>
        </div>
        <button id="pointer-button" class="btn btn-dark">Указатель</button>
        <div class="row">
            <div class="col-md-8 col-sm-8 mb-4">
                <h3 class="my-4" id="slides-label">Все слайды</h3>
                {% include "courses/slides_panel.html" %}
            </div>
            <div class="col-md-4 col-sm-4 mb-4 checkpoints-wrapper" id="checkpoints-wrapper">
                <h3 class="my-4" id="checkpoints-label">Контрольные точки</h3>
                {% include "courses/checkpoints_list.html" %}
                <h3 class="my-4" id="pointers-label">Указатели</h3>
                {% include "courses/pointers_list.html" %}
            </div>
        </div>
        <button id="save" class="btn btn-dark" type="submit">Сохранить</button>
    </div><!-- /.container -->

    <script>
        let presentationPlayerImage = $("#presentation-player-image");

        $(document).ready(function () {
            $("#cover-label").hide();
            $("#slides-label").hide();

            $("#checkpoints-label").hide();
            $("#checkpoints-list").hide();

            $("#audio-player").hide();

            $("#slide-controllers").hide();
            $("#pointer-button").hide();

            $("#pointers-label").hide();
            $("#pointers-list").hide();
        });

        $(window).resize(function () {
            resizeCourseCoverDiv();
        });

        function resizeCourseCoverDiv() {
            let courseCoverWidth = presentationPlayerImage.width();
            presentationPlayerImage.height(courseCoverWidth * imageHeight / imageWidth);
        }

        let course = {};
        let slides = [];
        let audioFile = {};
        let checkPoints = [];
        let pointers = [];
        let currentSlideshowSlideNumber = 0;
        let pointClicked;
        let pointing;
        let pointer;

        let imageHeight;
        let imageWidth;

        $("#presentation-input").change(function () {
            slides = [];
            $("#presentation-input-group").hide();
            $("#images").empty();
            $("#cover-label").show();
            $("#slides-label").show();

            let selectedFiles = this.files;

            for (let i = 0; i < selectedFiles.length; ++i) {
                slides.push({
                    number: i,
                    name: selectedFiles[i].name,
                    raw: selectedFiles[i]
                });
            }

            for (let i = 0; i < slides.length; ++i) {
                let fileReader = new FileReader();
                fileReader.onload = function () {
                    slides[i].data = fileReader.result;
                    check();
                };
                fileReader.readAsDataURL(slides[i].raw);
            }

            function check() {
                let ready = true;
                slides.forEach(function (e) {
                    if (!e.data) ready = false;
                });

                if (ready) done();
            }

            function done() {
                slides.sort(function (a, b) {
                    if (a.number > b.number) return 1;
                    if (a.number < b.number) return -1;
                    return 0;
                });

                slides.forEach(function (e) {
                    createImageDom(e);
                    addSlideToChooseList(e);
                });

                let image = new Image();
                image.src = slides[0].data;
                image.onload = function () {
                    imageWidth = image.naturalWidth;
                    imageHeight = image.naturalHeight;
                    console.log("(", imageWidth, "; ", imageHeight, ")");
                    resizeCourseCoverDiv();
                    presentationPlayerImage.css("background-image", "url(" + slides[0].data + ")");
                };

                console.log("slides: ", slides);
            }

            function addSlideToChooseList(slide) {
                let slideLine = $("<a>", {
                    class: "dropdown-item",
                    text: slide.name
                });
                slideLine.click(function () {
                    currentSlideshowSlideNumber = slide.number;
                    let checkPoint = {
                        number: checkPoints.length,
                        time: player.currentTime,
                        slide_number: currentSlideshowSlideNumber
                    };
                    checkPoints.push(checkPoint);
                    presentationPlayerImage.css("backgroundImage", "url(" + slide.data + ")");

                    checkPoints.sort(function (a, b) {
                        if (a.time > b.time) return 1;
                        if (a.time < b.time) return -1;
                        return 0;
                    });
                    for (let i = 0; i < checkPoints.length; ++i) {
                        checkPoints[i].number = i;
                    }
                    fillCheckPointsList();
                });
                $("#slide-list").append(slideLine);
            }

            if (!$("#audio-input").is(":visible")) {
                checkPoints.push({
                    number: 0,
                    time: 0,
                    slide_number: currentSlideshowSlideNumber
                });
                $("#slide-controllers").show();
                $("#pointer-button").show();

                $("#checkpoints-label").show();
                $("#checkpoints-list").show();

                $("#pointers-label").show();
                $("#pointers-list").show();
                fillCheckPointsList();
                fillPointersList();
            }
            console.log(slides);
        });

        $("#audio-input").change(function () {
            $("#audio-input-group").hide();

            let file = this.files[0];
            let audio = $("audio");

            audioFile.name = file.name;

            let fileReader = new FileReader();
            fileReader.onload = function () {
                audioFile.data = fileReader.result;
            };
            fileReader.readAsDataURL(file);

            audio.attr("src", URL.createObjectURL(file));
            $("#audio-player").show();

            if (!$("#presentation-input").is(":visible")) {
                checkPoints.push({
                    number: 0,
                    time: 0,
                    slide_number: currentSlideshowSlideNumber
                });
                $("#slide-controllers").show();
                $("#pointer-button").show();

                $("#checkpoints-label").show();
                $("#checkpoints-list").show();

                $("#pointers-label").show();
                $("#pointers-list").show();
                fillCheckPointsList();
                fillPointersList();
            }
        });

        $("#pointer-button").click(function () {
            pointClicked = true;
        });

        presentationPlayerImage.mousedown(function (e) {
            if (pointClicked) {
                pointing = true;
                let courseCover = presentationPlayerImage;
                let offset = courseCover.offset();
                let left = (e.pageX - offset.left) / courseCover.width() * 100;
                let top = (e.pageY - offset.top) / courseCover.height() * 100;
                pointer = {
                    start_time: player.currentTime,
                    points: [{
                        time: player.currentTime,
                        left: left,
                        top: top
                    }]
                }
            }
        });

        presentationPlayerImage.mousemove(function (e) {
            if (pointing) {
                let courseCover = presentationPlayerImage;
                let offset = courseCover.offset();
                let left = (e.pageX - offset.left) / courseCover.width() * 100;
                let top = (e.pageY - offset.top) / courseCover.height() * 100;
                pointer.points.push({
                    time: player.currentTime,
                    left: left,
                    top: top
                });
            }
        });

        $(document).mouseup(function () {
            if (pointing) {
                pointClicked = false;
                pointing = false;

                pointer.end_time = player.currentTime;
                pointers.push(pointer);
                pointers.sort(function (a, b) {
                    if (a.start_time > b.start_time) return 1;
                    if (a.start_time < b.start_time) return -1;
                    return 0;
                });
                fillPointersList();

                console.log(pointer);
                console.log(pointers);
            }
        });

        $("#next-slide-button").click(function () {
            if (currentSlideshowSlideNumber !== slides.length - 1) {
                currentSlideshowSlideNumber++;
                let checkPoint = {
                    number: checkPoints.length,
                    time: player.currentTime,
                    slide_number: currentSlideshowSlideNumber
                }
                checkPoints.push(checkPoint);
                console.log("here");

                checkPoints.sort(function (a, b) {
                    if (a.time > b.time) return 1;
                    if (a.time < b.time) return -1;
                    return 0;
                });

                let nextSlide = $.grep(slides, function (e) {
                    return e.number === currentSlideshowSlideNumber;
                })[0];

                presentationPlayerImage.css("backgroundImage", "url(" + nextSlide.data + ")");
                fillCheckPointsList();
            }
        });

        $("#save").click(function () {
            course.title = $("#title").val();
            course.description = $("#description").val();
            course.slides = slides;
            course.audio = audioFile;
            course.check_points = checkPoints;
            course.pointers = pointers;
            console.log(checkPoints);

            let formData = new FormData();
            formData.append("course", JSON.stringify(course));
            $.ajax({
                url: baseUrl + "courses/save_course",
                type: "POST",
                data: formData,
                processData: false,
                contentType: false,
                success: function (data) {
                    document.location.href = baseUrl + "courses";
                },
                error: function (data) {
                    console.log("error");
                }
            });
        });
    </script>
    <script src="{% static "js/audio-player.js" %}"></script>

{% endblock %}
