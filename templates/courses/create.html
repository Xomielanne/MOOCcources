{% extends "base.html" %}
{% load static %}
{% block content %}
    <div class="container">
        <h1 class="my-4">Create course</h1>
        <div class="form-group">
            <label for="title">Title</label>
            <input id="title" class="form-control">
        </div>
        <div class="form-group">
            <label for="description">Description</label>
            <textarea id="description" class="form-control" rows="4"></textarea>
        </div>

        <div id="presentation-input-group" class="form-group">
            <label for="upload">Презентация</label>
            <input id="presentation-input" type="file" multiple/>
        </div>
        <div id="audio-input-group" class="form-group">
            <label for="upload">Аудио-файл</label>
            <input id="audio-input" type="file"/>
        </div>

        <h2 class="my-4" id="cover-label">Course cover</h2>
        <div class="cover-wrapper">
            <img id="course-cover" class="img-fluid" src="" alt="">
            <div id="audio-player" class="audio green-audio-player">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
                <div class="play-pause-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="24" viewBox="0 0 18 24">
                        <path fill="#566574" fill-rule="evenodd" d="M18 12L0 24V0" class="play-pause-icon"
                              id="playPause"></path>
                    </svg>
                </div>

                <div class="controls">
                    <span class="current-time">0:00</span>
                    <div class="slider" data-direction="horizontal">
                        <div class="progress">
                            <div class="pin" id="progress-pin" data-method="rewind"></div>
                        </div>
                    </div>
                    <span class="total-time">0:00</span>
                </div>

                <div class="volume">
                    <div class="volume-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                            <path fill="#566574" fill-rule="evenodd"
                                  d="M14.667 0v2.747c3.853 1.146 6.666 4.72 6.666 8.946 0 4.227-2.813 7.787-6.666 8.934v2.76C20 22.173 24 17.4 24 11.693 24 5.987 20 1.213 14.667 0zM18 11.693c0-2.36-1.333-4.386-3.333-5.373v10.707c2-.947 3.333-2.987 3.333-5.334zm-18-4v8h5.333L12 22.36V1.027L5.333 7.693H0z"
                                  id="speaker"></path>
                        </svg>
                    </div>
                    <div class="volume-controls hidden">
                        <div class="slider" data-direction="vertical">
                            <div class="progress">
                                <div class="pin" id="volume-pin" data-method="changeVolume"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <audio crossorigin>
                    <source id="audio-source" src="" type="audio/mpeg">
                </audio>
            </div>
            <div id="slide-controllers">
                <button id="next-slide-button" class="btn btn-dark" type="submit">Next slide</button>
                <div class="dropdown">
                    <button id="choose-slide-button" class="btn btn-secondary dropdown-toggle" type="button"
                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        Choose slide
                    </button>
                    <div id="slide-list" class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                    </div>
                </div>
            </div>
        </div>
        <h3 class="my-4" id="slides-label">All slides</h3>
        <div class="row" id="images">
        </div>
        <button id="save" class="btn btn-dark" type="submit">Save</button>
    </div><!-- /.container -->

    <script>
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== "") {
                let cookies = document.cookie.split(";");
                for (let i = 0; i < cookies.length; i++) {
                    let cookie = jQuery.trim(cookies[i]);
                    if (cookie.substring(0, name.length + 1) === (name + "=")) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        $.ajaxSetup({
            contentType: "application/json; charset=utf-8",
            beforeSend: function (xhr, settings) {
                if (!this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", getCookie("csrftoken"));
                }
            }
        });

        $(document).ready(function () {
            $("#cover-label").hide();
            $("#slides-label").hide();
            $("#audio-player").hide();
            $("#slide-controllers").hide();
        });

        let course = {};
        let slides = [];
        let audioFile = {};
        let checkPoints = [];
        let currentSlideshowSlideNumber = 0;
        $("#presentation-input").change(function () {
            $("#presentation-input-group").hide();
            slides = [];
            $("#images").empty();
            $("#cover-label").show();
            $("#slides-label").show();
            let selectedFiles = this.files;

            for (let i = 0; i < selectedFiles.length; ++i) {
                slides.push({
                    number: i,
                    name: selectedFiles[i].name,
                    raw: selectedFiles[i]
                });
            }

            for (let i = 0; i < slides.length; ++i) {
                let fileReader = new FileReader();
                fileReader.onload = function () {
                    slides[i].data = fileReader.result;
                    check();
                };
                fileReader.readAsDataURL(slides[i].raw);
            }

            function check() {
                let ready = true;
                slides.forEach(function (e) {
                    if (!e.data) ready = false;
                })

                if (ready) done();
            }

            function done() {
                slides.sort(function (a, b) {
                    if (a.number > b.number) return 1;
                    if (a.number < b.number) return -1;
                    return 0;
                })

                slides.forEach(function (e) {
                    createImageDom(e);
                    addSlideToChooseList(e);
                })
            }

            function createImageDom(slide) {
                let cardWrapper = $("<div>", {
                    class: "col-lg-3 col-md-4 col-sm-6 portfolio-item"
                });
                let imageWrapper = $("<div>", {
                    class: "card h-100"
                });
                let image = $("<img>", {
                    class: "card-img-top",
                    src: slide.data,
                    id: "image" + slide.id,
                });
                let cardBody = $("<div>", {
                    class: "slide-name",
                    text: slide.name
                });

                imageWrapper.append(image);
                imageWrapper.append(cardBody);

                cardWrapper.append(imageWrapper);
                $("#images").append(cardWrapper);

                if (slide.number === 0) {
                    $("#course-cover").attr("src", slide.data);
                    currentSlideshowSlideNumber = 0;
                }
            }

            function addSlideToChooseList(slide) {
                let slideLine = $("<a>", {
                    class: "dropdown-item",
                    text: slide.name
                });
                slideLine.click(function () {
                    currentSlideshowSlideNumber = slide.number;
                    checkPoints.push({
                        number: checkPoints.length,
                        time: player.currentTime,
                        slide_number: currentSlideshowSlideNumber
                    });
                    $("#course-cover").attr("src", slide.data);
                });
                $("#slide-list").append(slideLine);
            }

            if (!$("#audio-input").is(":visible")) {
                $("#slide-controllers").show();
                checkPoints.push({
                    number: 0,
                    time: 0,
                    slide_number: currentSlideshowSlideNumber
                });
            }
            console.log(slides);
        });

        $("#audio-input").change(function () {
            $("#audio-input-group").hide();

            let file = this.files[0];
            let audio = $("audio");

            audioFile.name = file.name;

            let fileReader = new FileReader();
            fileReader.onload = function () {
                audioFile.data = fileReader.result;
            };
            fileReader.readAsDataURL(file);

            audio.attr("src", URL.createObjectURL(file));
            $("#audio-player").show();

            if (!$("#presentation-input").is(":visible")) {
                $("#slide-controllers").show();
                checkPoints.push({
                    number: 0,
                    time: 0,
                    slide_number: currentSlideshowSlideNumber
                });
            }
        });

        $("#next-slide-button").click(function () {
            currentSlideshowSlideNumber++;
            checkPoints.push({
                number: checkPoints.length,
                time: player.currentTime,
                slide_number: currentSlideshowSlideNumber
            });

            console.log(currentSlideshowSlideNumber);
            let nextSlide = $.grep(slides, function (e) {
                return e.number === currentSlideshowSlideNumber;
            })[0];
            console.log(nextSlide);
            $("#course-cover").attr("src", nextSlide.data);
        });

        $("#save").click(function () {
            course.title = $("#title").val();
            course.description = $("#description").val();
            course.slides = slides;
            course.audio = audioFile;
            course.check_points = checkPoints;
            console.log(checkPoints);

            let formData = new FormData();
            formData.append("course", JSON.stringify(course));
            $.ajax({
                url: baseUrl + "courses/save_course",
                type: "POST",
                data: formData,
                processData: false,
                contentType: false,
                success: function (data) {
                    document.location.href = baseUrl + "courses";
                },
                error: function (data) {
                    console.log("error");
                }
            });
        });
    </script>
    <script src="{% static "js/audio-player.js" %}"></script>

{% endblock %}
