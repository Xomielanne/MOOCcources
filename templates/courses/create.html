{% extends "base.html" %}
{% block content %}
    <div class="container">
        <h1 class="my-4">Создать курс</h1>
        <div class="form-group">
            <label for="title">Название</label>
            <input id="title" class="form-control">
        </div>
        <div class="form-group">
            <label for="description">Описание</label>
            <textarea id="description" class="form-control" rows="4"></textarea>
        </div>

        <div id="presentation-input-group" class="form-group">
            <label for="upload">Презентация</label>
            <input id="presentation-input" type="file" multiple/>
        </div>
        <div id="audio-input-group" class="form-group">
            <label for="upload">Аудио-файл</label>
            <input id="audio-input" type="file"/>
        </div>

        <h2 class="my-4" id="current-image-label">Текущий слайд</h2>
        {% include "courses/presentation-player.html" %}
        <div id="slide-controllers" class="btn-group">
            <button id="next-slide-button" class="btn btn-dark">Следующий слайд</button>
            <div class="dropdown">
                <button id="choose-slide-button" class="btn btn-secondary dropdown-toggle" type="button"
                        data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Выбрать слайд
                </button>
                <div id="slide-list" class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                </div>
            </div>
        </div>
        {% include "courses/presentation-controllers.html" %}
        <button id="save" class="btn btn-dark" type="submit">Сохранить</button>
    </div><!-- /.container -->

    <script>
        $(document).ready(function () {
            $("#current-image-label").hide();
            $("#slides-label").hide();

            $("#checkpoints-label").hide();
            $("#checkpoints-list").hide();

            $("#audio-player").hide();

            $("#slide-controllers").hide();
            $("#pointer-button").hide();

            $("#pointers-label").hide();
            $("#pointers-list").hide();
        });

        $(window).resize(function () {
            resizeCourseCoverDiv();
        });

        function resizeCourseCoverDiv() {
            let courseCoverWidth = presentationPlayerImage.width();
            presentationPlayerImage.height(courseCoverWidth * imageHeight / imageWidth);
        }

        let course = {};
        let slideList = [];
        let audioFile = {};
        let checkPoints = [];
        let pointers = [];
        let pointClicked;
        let pointing;
        let pointer;

        $("#presentation-input").change(function () {
            slideList = [];
            $("#presentation-input-group").hide();
            $("#images").empty();
            $("#current-image-label").show();
            $("#image-box").show();
            $("#slides-label").show();

            let selectedFiles = this.files;

            for (let i = 0; i < selectedFiles.length; ++i) {
                slideList.push({
                    number: i,
                    name: selectedFiles[i].name,
                    raw: selectedFiles[i]
                });
            }

            for (let i = 0; i < slideList.length; ++i) {
                let fileReader = new FileReader();
                fileReader.onload = function () {
                    slideList[i].image = fileReader.result;
                    check();
                };
                fileReader.readAsDataURL(slideList[i].raw);
            }

            function check() {
                let ready = true;
                slideList.forEach(function (e) {
                    if (!e.image) ready = false;
                });

                if (ready) done();
            }

            function done() {
                slideList.sort(function (a, b) {
                    if (a.number > b.number) return 1;
                    if (a.number < b.number) return -1;
                    return 0;
                });

                slideList.forEach(function (e) {
                    createImageDom(e);
                    addSlideToChooseList(e);
                });

                getImageSize(slideList[0].image);
                resizePresentationImageDiv();
                presentationPlayerImage.css("background-image", "url(" + slideList[0].image + ")")
            }

            if (!$("#audio-input").is(":visible")) {
                checkPoints.push({
                    number: 0,
                    time: 0,
                    slide_name: slideList[0].name,
                    slide_number: 0
                });
                $("#slide-controllers").show();
                $("#pointer-button").show();

                $("#checkpoints-label").show();
                $("#checkpoints-list").show();

                $("#pointers-label").show();
                $("#pointers-list").show();
                fillCheckPointsList();
                fillPointersList();
            }
        });

        $("#audio-input").change(function () {
            $("#audio-input-group").hide();

            let file = this.files[0];
            let audio = $("audio");

            audioFile.name = file.name;

            let fileReader = new FileReader();
            fileReader.onload = function () {
                audioFile.data = fileReader.result;
            };
            fileReader.readAsDataURL(file);

            audio.attr("src", URL.createObjectURL(file));
            $("#audio-player").show();

            if (!$("#presentation-input").is(":visible")) {
                checkPoints.push({
                    number: 0,
                    time: 0,
                    slide_name: slideList[0].name,
                    slide_number: 0
                });
                $("#slide-controllers").show();
                $("#pointer-button").show();

                $("#checkpoints-label").show();
                $("#checkpoints-list").show();

                $("#pointers-label").show();
                $("#pointers-list").show();
                fillCheckPointsList();
                fillPointersList();
            }
        });

        $("#pointer-button").click(function () {
            pointClicked = true;
        });

        presentationPlayerImage.mousedown(function (e) {
            if (pointClicked) {
                pointing = true;
                let courseCover = presentationPlayerImage;
                let offset = courseCover.offset();
                let left = (e.pageX - offset.left) / courseCover.width() * 100;
                let top = (e.pageY - offset.top) / courseCover.height() * 100;
                pointer = {
                    start_time: player.currentTime,
                    points: [{
                        time: player.currentTime,
                        left: left,
                        top: top
                    }]
                }
            }
        });

        presentationPlayerImage.mousemove(function (e) {
            if (pointing) {
                let courseCover = presentationPlayerImage;
                let offset = courseCover.offset();
                let left = (e.pageX - offset.left) / courseCover.width() * 100;
                let top = (e.pageY - offset.top) / courseCover.height() * 100;
                pointer.points.push({
                    time: player.currentTime,
                    left: left,
                    top: top
                });
            }
        });

        $(document).mouseup(function () {
            if (pointing) {
                pointClicked = false;
                pointing = false;

                pointer.end_time = player.currentTime;
                pointers.push(pointer);
                pointers.sort(function (a, b) {
                    if (a.start_time > b.start_time) return 1;
                    if (a.start_time < b.start_time) return -1;
                    return 0;
                });
                fillPointersList();
            }
        });

        $("#next-slide-button").click(function () {
            if (currentSlideshowSlideNumber !== slideList.length - 1) {
                currentSlideshowSlideNumber++;
                let slide = $.grep(slideList, function (e) {
                    return e.number === currentSlideshowSlideNumber;
                })[0];
                let checkPoint = {
                    number: checkPoints.length,
                    time: player.currentTime,
                    slide_name: slide.name,
                    slide_number: currentSlideshowSlideNumber
                }
                checkPoints.push(checkPoint);

                checkPoints.sort(function (a, b) {
                    if (a.time > b.time) return 1;
                    if (a.time < b.time) return -1;
                    return 0;
                });

                let nextSlide = $.grep(slideList, function (e) {
                    return e.number === currentSlideshowSlideNumber;
                })[0];

                presentationPlayerImage.css("backgroundImage", "url(" + nextSlide.image + ")");
                fillCheckPointsList();
            }
        });

        $("#save").click(function () {
            course.title = $("#title").val();
            course.description = $("#description").val();
            course.slides = slideList;
            course.audio = audioFile;
            course.check_points = checkPoints;
            course.pointers = pointers;

            console.log(checkPoints);

            let formData = new FormData();
            formData.append("course", JSON.stringify(course));
            $.ajax({
                url: baseUrl + "courses/save_course",
                type: "POST",
                data: formData,
                processData: false,
                contentType: false,
                success: function (data) {
                    document.location.href = baseUrl + "courses";
                },
                error: function (data) {
                    console.log("error");
                }
            });
        });
    </script>

{% endblock %}
